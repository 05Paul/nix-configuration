#!/usr/bin/env bash

# get each set of usernames from the git config (which will be generated from our `default.nix` above)
IDENTITIES=$(git config --global --name-only --get-regexp "user.*..name" | sed -e 's/^user.//' -e 's/.name$//')
# filter them with fzf
ID=$(echo "${IDENTITIES}" | fzf -e -1 +m -q "$1")
if ! git config --global --get-regexp "user.${ID}.name" > /dev/null; then
    echo "Please use a valid git identity
Options:"
    git config --global --name-only --get-regexp "user.*..name" | sed -e 's/^user.//' -e 's/.name$//' -e 's/^/\t/'
    exit 1
fi

SIGNING_KEY=$(git config user.${ID}.signingKey)
if [ -z "$SIGNING_KEY" ]; then
    KEYS=$(gpg --list-keys --with-colons | jc --gpg | jq -r '
        reduce .[] as $r (
          { cur: null, out: [] };

          if $r.type == "pub" then
            .cur.fpr = null

          elif $r.type == "fpr" then
            .cur.fpr = $r.user_id

          elif $r.type == "uid" then
            .cur.uid = $r.user_id |
            .out += [ .cur ]

          else
            .
          end
        )
        | .out.[]
        | "\(.uid)\t\(.fpr)"
        ')
    SIGNING_KEY=$(echo "${KEYS}" | fzf --with-nth=1 --delimiter=$'\t' --accept-nth=2 -1 | sed -E 's/([A-Fa-f0-9]{4})/\1 /g; s/^(([^ ]+ ){5})/\1 /; s/ +$//' )
fi

# set the ID locally in each repo (eg in the repo's .git/config)
git config user.name "$(git config user.${ID}.name)"
git config user.email "$(git config user.${ID}.email)"
git config user.signingKey "$SIGNING_KEY"

echo "Name: $(git config user.name)"
echo "Email: $(git config user.email)"
echo "SigningKey: $(git config user.signingKey)"
